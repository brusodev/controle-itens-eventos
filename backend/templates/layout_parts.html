{% macro sidebar(usuario_nome, usuario_perfil, current_path='') %}
    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-toggle" onclick="toggleSidebar()">
            <span>&lsaquo;</span>
        </div>
        
        <div class="sidebar-header">
            <div class="sidebar-logo">ğŸ¯</div>
            <div class="sidebar-title">Controle Itens</div>
        </div>

        <div class="sidebar-menu">
            <a href="/dashboard" class="menu-item {{ 'active' if '/dashboard' in current_path }}" id="menu-dashboard" title="Trocar MÃ³dulo">
                <span class="menu-icon">ğŸ”„</span>
                <span class="menu-text">Trocar MÃ³dulo</span>
            </a>
            
            <div class="menu-divider"></div>

            <a href="/estoque" class="menu-item {{ 'active' if '/estoque' in current_path or '/alimentacao' in current_path }}" id="menu-alimentacao" title="Itens">
                <span class="menu-icon">ğŸ“¦</span>
                <span class="menu-text">Estoque</span>
            </a>
            <a href="/categorias" class="menu-item {{ 'active' if '/categorias' in current_path or secao_ativa == 'categorias' }}" id="menu-categorias" title="Categorias">
                <span class="menu-icon">ğŸ·ï¸</span>
                <span class="menu-text">Categorias</span>
            </a>
            <a href="/emitir-os" class="menu-item {{ 'active' if '/emitir-os' in current_path }}" id="menu-emitir-os" title="Emitir O.S.">
                <span class="menu-icon">ğŸ“</span>
                <span class="menu-text">Emitir O.S.</span>
            </a>
            <a href="/ordens-servico" class="menu-item {{ 'active' if '/ordens-servico' in current_path }}" id="menu-ordens" title="Minhas Ordens">
                <span class="menu-icon">ğŸ“‹</span>
                <span class="menu-text">Ordens</span>
            </a>
            <a href="/relatorios" class="menu-item {{ 'active' if '/relatorios' in current_path }}" id="menu-relatorios" title="RelatÃ³rios">
                <span class="menu-icon">ğŸ“Š</span>
                <span class="menu-text">RelatÃ³rios</span>
            </a>
            
            <div class="menu-divider"></div>

            <a href="/detentoras" class="menu-item {{ 'active' if '/detentoras' in current_path }}" id="menu-detentoras" title="Detentoras">
                <span class="menu-icon">ğŸ¢</span>
                <span class="menu-text">Detentoras</span>
            </a>

            {% if usuario_perfil == 'admin' %}
            <a href="/gerenciar-usuarios" class="menu-item {{ 'active' if '/gerenciar-usuarios' in current_path }}" id="menu-usuarios" title="UsuÃ¡rios">
                <span class="menu-icon">ğŸ‘¥</span>
                <span class="menu-text">UsuÃ¡rios</span>
            </a>
            <a href="/api/auditoria/view" class="menu-item {{ 'active' if '/auditoria' in current_path }}" id="menu-auditoria" title="Auditoria">
                <span class="menu-icon">ğŸ•µ</span>
                <span class="menu-text">Auditoria</span>
            </a>
            {% endif %}
        </div>

        <div class="sidebar-footer">
            <div class="sidebar-user-summary">
                <div class="sidebar-user-avatar">{{ usuario_nome[0] if usuario_nome else 'U' }}</div>
                <div class="sidebar-user-info">
                    <div class="sidebar-user-name">{{ usuario_nome.split()[0] if usuario_nome else 'UsuÃ¡rio' }}</div>
                    <div class="sidebar-user-role">{{ usuario_perfil }}</div>
                </div>
            </div>
        </div>
    </aside>
{% endmacro %}

{% macro topbar(usuario_nome) %}
    <!-- Topbar -->
    <div class="topbar">
        <div class="topbar-left">
            <div class="mobile-toggle" onclick="toggleMobileSidebar()">
                <span></span>
                <span></span>
                <span></span>
            </div>
            <h2 id="page-module-title">MÃ³dulo: Carregando...</h2>
        </div>
        <div class="topbar-right">
            <div class="dropdown">
                <button class="topbar-user-btn" onclick="toggleUserDropdown()">
                    {{ (usuario_nome.split()[0] if usuario_nome else 'UsuÃ¡rio') | upper }} â–¼
                </button>
                <div class="dropdown-content" id="user-dropdown">
                    <a href="/gerenciar-conta">ğŸ‘¤ Meu Perfil</a>
                    <a href="/alterar-senha">ğŸ” Alterar Senha</a>
                    <div class="dropdown-divider"></div>
                    <a href="javascript:void(0)" onclick="fazerLogout()" style="color: #d32f2f;">ğŸšª Sair</a>
                </div>
            </div>
        </div>
    </div>
{% endmacro %}

{% macro script_layout() %}
    <script>
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('collapsed');
            localStorage.setItem('sidebar_collapsed', sidebar.classList.contains('collapsed'));
        }

        function toggleMobileSidebar() {
            document.getElementById('sidebar').classList.toggle('mobile-active');
        }

        function toggleUserDropdown() {
            const dropdown = document.getElementById('user-dropdown');
            dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
        }

        function fazerLogout() {
            if (confirm('Deseja realmente sair?')) {
                window.location.href = '/auth/logout';
            }
        }

        function mostrarAbaCategories() {
            window.location.href = '/categorias';
        }

        // Recuperar estado do sidebar e atualizar tÃ­tulo do mÃ³dulo
        document.addEventListener('DOMContentLoaded', () => {
            if (localStorage.getItem('sidebar_collapsed') === 'true') {
                document.getElementById('sidebar').classList.add('collapsed');
            }

            // Atualizar tÃ­tulo do mÃ³dulo na topbar imediatamente
            const modulo = localStorage.getItem('modulo_atual') || 'coffee';
            const moduloConfig = {
                'coffee': { icon: 'â˜•', label: 'Coffee Break', menuIcon: 'ğŸ½ï¸', menuText: 'Itens do Coffee' },
                'transporte': { icon: 'ğŸšš', label: 'Transporte', menuIcon: 'ğŸš', menuText: 'Itens Transporte' },
                'organizacao': { icon: 'ğŸ“‹', label: 'OrganizaÃ§Ã£o', menuIcon: 'ğŸ“‹', menuText: 'Itens OrganizaÃ§Ã£o' },
                'hospedagem': { icon: 'ğŸ›ï¸', label: 'Hospedagem', menuIcon: 'ğŸ¨', menuText: 'Itens de Hospedagem' }
            };
            const cfg = moduloConfig[modulo] || moduloConfig['coffee'];

            const titleElement = document.getElementById('page-module-title');
            if (titleElement) {
                titleElement.textContent = `MÃ³dulo: ${cfg.icon} ${cfg.label}`;
            }

            // Atualizar label do menu de estoque conforme mÃ³dulo
            const menuAlimentacao = document.getElementById('menu-alimentacao');
            if (menuAlimentacao) {
                const iconSpan = menuAlimentacao.querySelector('.menu-icon');
                const textSpan = menuAlimentacao.querySelector('.menu-text');
                if (iconSpan) iconSpan.textContent = cfg.menuIcon;
                if (textSpan) textSpan.textContent = cfg.menuText;
            }
        });
    </script>
{% endmacro %}
